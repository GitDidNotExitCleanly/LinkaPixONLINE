<!DOCTYPE html>
<html>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<body>

    <input class="joint upld" type='file' id="imgInp" />
    Width: <input type="number" name="width" id="width" value="10">
    Height: <input type="number" name="height" id="height" value="7">

    <button class="submit">Submit!</button>


    <canvas id="myCanvas" width="576" height="432"></canvas>
    <script>

    var data;

    function analyse_puzzle(src, callback) {
      var canvas = document.getElementById('myCanvas');
      var ctx = canvas.getContext('2d');
      var imageObj = new Image();
      imageObj.src = src;

      imageObj.onload = function() {
         ctx.drawImage(imageObj, 0, 0);

         console.log(parseInt($('#width').val()));

			var width = parseInt($('#width').val()); // User specified
			var height = parseInt($('#height').val()); // User specified
			
			var blockWidth = Math.round(canvas.width / width);
			var blockHeight = Math.round(canvas.height / height);

			var pixArray = new Array(height);
			for (var m = 0; m < pixArray.length; m++) {
				pixArray[m] = new Array(width);
			}
			
			var white = [255, 255, 255];
			var black = [0, 0, 0];

			for (i = 0; i < height; i++) {
				for (j = 0; j < width; j++) {
					var imgData = ctx.getImageData(j * blockWidth + blockWidth / 2, i * blockHeight + blockHeight / 2, 1, 1);
					
					disWhite = (white[0] - imgData.data[0]) + (white[1] - imgData.data[1]) + (white[2] - imgData.data[2]);
					disBlack = (imgData.data[0] - black[0]) + (imgData.data[1] - black[1]) + (imgData.data[2] - black[2]);
					if (disWhite < 10) {
						pixArray[i][j] = 0;
					} else if (disBlack < 10) {
						pixArray[i][j] = 1;
					} else {
						pixArray[i][j] = 2;
					}
				}
			}
			console.log(pixArray);
            callback(pixArray);
        };
        return data;
    };



    function readURL(input) {

        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                analyse_puzzle(e.target.result, function(pixArray) {
                    $('<form class="hidden-form" action="/upload" method="post" style="display: none;">' +
                        '<textarea name="data"></textarea>' +
                        '<input name="width" value="'+parseInt($('#width').val())+'">' +
                        '<input name="height" value="'+parseInt($('#height').val())+'"></form>').appendTo('body');
            //console.log(JSON.stringify(analysed));
            console.log(pixArray);
            $('[name="data"]').val(JSON.stringify(pixArray));
        });
            /*console.log(data);
            $('<form class="hidden-form" action="/upload" method="post" style="display: none;"><textarea name="data"></textarea></form>').appendTo('body');
            //console.log(JSON.stringify(analysed));
            console.log(data);
            console.log(analysed);
            $('[name="data"]').val(JSON.stringify(analysed));*/
        }
        reader.readAsDataURL(input.files[0]);
    }
}

$(".upld").change(function () {
    readURL(this);
});



$('button').on('click', function() {
	console.log('wat');
    $('.hidden-form').submit();
});



</script>

</body>
</html>